apiVersion: v1
kind: Namespace
metadata:
  name: nginx-ingress
  labels:
    kubernetes.io/metadata.name: nginx-ingress
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: nginx-resource-limits
  namespace: nginx-ingress
spec:
  hard:
    requests.cpu: "500m"
    requests.memory: "512Mi"
    limits.cpu: "1"
    limits.memory: "1Gi"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nginx-ingress
  namespace: nginx-ingress
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nginx-ingress
rules:
- apiGroups: [""]
  resources: ["services", "endpoints", "pods", "secrets", "configmaps", "namespaces", "nodes", "events"]
  verbs: ["get", "list", "watch", "create", "patch", "update"]
- apiGroups: ["discovery.k8s.io"]
  resources: ["endpointslices"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses", "ingressclasses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["networking.k8s.io"]
  resources: ["ingresses/status"]
  verbs: ["update"]
- apiGroups: ["k8s.nginx.org"]
  resources: ["virtualservers", "virtualserverroutes", "globalconfigurations", "transportservers", "policies"]
  verbs: ["get", "list", "watch", "update"]
- apiGroups: ["k8s.nginx.org"]
  resources: ["virtualservers/status", "virtualserverroutes/status", "transportservers/status"]
  verbs: ["update"]
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: nginx-ingress
subjects:
- kind: ServiceAccount
  name: nginx-ingress
  namespace: nginx-ingress
roleRef:
  kind: ClusterRole
  name: nginx-ingress
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: nginx
spec:
  controller: nginx.org/ingress-controller
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: nginx-ingress
data:
  # Built-in HSTS support
  hsts: "true"
  hsts-max-age: "63072000"
  hsts-include-subdomains: "true"
  hsts-preload: "true" 
  # Using server-snippets for more reliable header injection
  server-snippets: |
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
---
apiVersion: k8s.nginx.org/v1
kind: GlobalConfiguration
metadata:
  name: nginx-configuration
  namespace: nginx-ingress
spec:
  listeners:
  - name: wireguard-udp
    port: 51820
    protocol: UDP
---
apiVersion: k8s.nginx.org/v1
kind: TransportServer
metadata:
  name: nginx-wireguard-proxy
  namespace: nginx-ingress
spec:
  ingressClassName: nginx
  listener:
    name: wireguard-udp
    protocol: UDP
  upstreams:
  - name: omada-gateway
    service: omada-wireguard-proxy
    port: 51820
  action:
    pass: omada-gateway
---
apiVersion: v1
kind: Service
metadata:
  name: omada-wireguard-proxy
  namespace: nginx-ingress
spec:
  ports:
  - port: 51820
    protocol: UDP
    targetPort: 51820
    name: wireguard
---
apiVersion: v1
kind: Endpoints
metadata:
  name: omada-wireguard-proxy
  namespace: nginx-ingress
subsets:
  - addresses:
      - ip: 10.50.1.1
    ports:
      - port: 51820
        protocol: UDP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress
  namespace: nginx-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-ingress
  template:
    metadata:
      labels:
        app: nginx-ingress
    spec:
      serviceAccountName: nginx-ingress
      containers:
      - image: nginx/nginx-ingress:3.5.0
        name: nginx-ingress
        args:
          - -ingress-class=nginx
          - -enable-custom-resources
          - -enable-snippets
          - -nginx-configmaps=$(POD_NAMESPACE)/nginx-config
          - -global-configuration=$(POD_NAMESPACE)/nginx-configuration
          - -enable-leader-election=false
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        ports:
        - name: http
          containerPort: 80
        - name: https
          containerPort: 443
        - name: wireguard-udp
          containerPort: 51820
          protocol: UDP
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - ALL
          runAsUser: 101
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-ingress
  namespace: nginx-ingress
  annotations:
    metallb.universe.tf/allow-shared-ip: "ingress-services"
spec:
  loadBalancerIP: 10.50.1.204
  externalTrafficPolicy: Local
  type: LoadBalancer
  selector:
    app: nginx-ingress
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  - name: https
    port: 443
    protocol: TCP
    targetPort: 443
  - name: wireguard-udp
    port: 443 
    protocol: UDP
    targetPort: 51820
